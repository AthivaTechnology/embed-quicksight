<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <style>
      #SelectDashboard { width:200px; } 
      #DashboardSelector { margin-right:40px; }
      #NavDashboards { margin-right:40px; }
      #NavbarLogo {height: 50px; }
      
      #DisplayMessageContainer, #DashboardSelector, #DashboardSelectorHeader { visibility: visible; }
      #DashboardContainer, #ConsoleContainer { visibility: hidden; }
        
      #DisplayParent { height: calc(100vh - 76px); width: 100vw; position: absolute; top:76px; background-color:#e9ecef;
        overflow:hidden; }
      .HideQ #DashboardContainer, .HideQ #DisplayMessageContainer, #ConsoleContainer { height: calc(100vh - 76px);
        width: 100vw; position: absolute; top:0px; background-color:#e9ecef; overflow:hidden; }
      .HideQ #QContainer { height:40px; width:calc( 100vw - 100px ); position:absolute; top:2px; left:50px;
        overflow:visible; visibility:hidden; }
      .ShowQ #DashboardContainer, .ShowQ #ConsoleContainer, .ShowQ #DisplayMessageContainer { height: calc(100vh - 76px - 40px);
        width: 100vw; position: absolute; top:40px; background-color:#e9ecef; overflow:hidden; }
      .ShowQ #QContainer { height:40px; width:100vw; position:absolute; top:2px; overflow:visible;}
      #QBackdrop { position:absolute; top:0px; left:0px; height:calc( 100vh - 76px ); width:100vw; overflow:hidden;
        background-color:#000000; opacity: 0.5; }
      .UninitializedDashboard #DashboardContainer, .InitializedDashboard #DashboardContainer { visibility: hidden; }
      .Dashboard #DisplayMessageContainer, .Dashboard #ConsoleContainer { visibility: hidden; }
      .Dashboard #DashboardContainer, .Dashboard #DashboardSelector, .Dashboard #DashboardSelectorHeader { visibility: visible; }
      
      .Console #DisplayMessageContainer, .Console #DashboardContainer, .Console #DashboardSelector, .Console #DashboardSelectorHeader { visibility: hidden; }
      .Console #ConsoleContainer { visibility: visible; }
      
      
      iframe {border: 0;}
      body {margin:0;}
    </style>
    
    <script src="https://unpkg.com/amazon-quicksight-embedding-sdk@2.7.0/dist/quicksight-embedding-js-sdk.min.js" integrity="sha384-O2wCIBOIwZbxIE+tziSb3EdX3568XSnwEmKWWEBWrHoezYpkJHwfVbd7bsdFiC52" crossorigin="anonymous"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous"></script>  
    
    <script nonce="<ScriptNonce>">
      //The placeholders in this section is filled from lambda python code.
      //This HTML page is written to be a static single page application. Filling in the values dynamically just for ease of demo setup.
      //If you put this file on a static web server (say S3, S3 + CloudFront), you can fill in the place holders. 
      //In that case, Ensure that staticPageUrl is set to the static url of this page.
      var awsData = {
          apiGatewayUrl:'<apiGatewayUrl>',
          staticPageUrl:'<apiGatewayUrl>',
          cognitoDomainUrl:'<cognitoDomainUrl>',
          cognitoClientId:'<cognitoClientId>',
          embeddingContext:{},
          embeddedDashboardExperience:{},
          InitialDashboardEmbedUrl: '',
          embeddedConsoleExperience:{},
          embeddedQExperience: {},
          dashboardClass:'UninitializedDashboard',
          dashboardInitialLoad:true,
          qMode:'<qMode>',
          timerId:'',
          debugMode: true
      };
      
      if (!awsData.debugMode) {
        console.log = function(){};
      }
      
      
      $(document).ready(function () {
        
        //Specify whether Q bar has to be displayed or not. This value flows in from lambda layer.
        $('#DisplayParent').addClass('<qDisplaySelection>');
        
        //Once the page loads, invoke getOpenIdToken function.
        getOpenIdToken();
        $('#NavEmbeddedConsole').on("click",function(){ setVisibility('Console') });
        $('#NavEmbeddedDashboards').on("click",function(){ setVisibility('Dashboard') });
        $('#NavSignOut').on("click", signOut );
        $('#SelectDashboard').on("change",function(){ selectDashboard($(this).val()) });
        
      });
  
      //Redirect to Cognito if user is not Signed in.
      //Cognito will redirect back to this page once user signs in.
      //If hosting on static web server, ensure that the static page url is configured in Cognito as Callback and SignOut urls.
      //Once token is available, proceed on to getting QuickSight info.
    	function getOpenIdToken(){
      		console.log('In getOpenIdToken func');
      		//Check for token in url as well as in Cookie
      		var idToken = getParameterValues('id_token','#','&') ?? getCookieField('openIdToken');
      		console.log(idToken)
      		if (idToken ) {
            console.log('Token found');
            //Remove the url fragment with token details. This will be stored into a local cookie.
            window.location.hash='';
            getQuickSightInfo(idToken);
      		}
      		else {
      			console.log('Token not found, Redirecting to Cognito');
      			window.location.href = awsData.cognitoDomainUrl+'/login?client_id='+awsData.cognitoClientId+'&response_type=token&scope=openid+profile&redirect_uri='+awsData.staticPageUrl;
      		}
    	}
  
      //Function used to extract parts of the url.
      //Extracted parts are stored as cookies and value retrieved from cookie on subsequent calls.
      function getParameterValues(param,slicer,delimiter) {
        console.log('In getParameterValues func');
        var urlParms = window.location.href.slice(window.location.href.indexOf(slicer)+ slicer.length).split(delimiter);
        for (var i = 0; i < urlParms.length; i++) {
          var urlparm = urlParms[i].split('=');
          if (urlparm[0].toLowerCase() === param) {
            return decodeURIComponent(urlparm[1]);
          }
        }
        return
      }
      
      //Return value stored in cookie. If cookie is not found, null is returned.
      function getCookie(name) {
        console.log('In getCookie func');
        var v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
        return v ? v[2] : null;
      }
  
      //Sets cookies with an expiry of 1 hour.
    	function setCookie(name, value) {
        console.log('In setCookie func');
        document.cookie = name + "=" + value +"; Max-Age=3600; SameSite=Strict";
      }
  
      function getCookieField(fieldName) {
        console.log('In getCookieField function');
        cookie = getCookie('QSEmbedDemo');
        if (cookie)
        {
          fieldValue = JSON.parse(cookie)[fieldName];
          return fieldValue
        }
        else
        {
          signOut();
        }
      }  
      //Make APIGateway calls to retrieve info from QuickSight.
      async function getQuickSightInfo(openIdToken) {
        console.log('In getQuickSightInfo func');
        //Create embedding context
        const contextOptions = { onChange: function(event){ HandleEvent('CONTEXT-CHANGE-EVENT', event) } };
        awsData.embeddingContext = await QuickSightEmbedding.createEmbeddingContext(contextOptions);
        
        const parameters = {
            openIdToken: openIdToken,
            timestamp: new Date().getTime()  //Timestamp added just to ensure that browsers don't use cached response.
        };
  
        const myQueryString = $.param(parameters);
   
        //Retrieve list of dashboards that the user can access from QuickSight.
        $.ajax({
              url: awsData.apiGatewayUrl + '?mode=getDashboardList&' + myQueryString,
              contentType: "text/plain",
              dataType: 'json',
              success: function(result){
                  console.log(result.Dashboards);
                  loadDashboardList(result.Dashboards);
                  //In addition to dashboard list, we get back the token and expiry timestamp in the response. These are stored as a cookie
                  setCookie('QSEmbedDemo','{"openIdToken":"'+result.openIdToken+'", "expiryTs":'+result.expiryTs+'}',parseInt(result.expiryTs - Date.now()/1000));
                  //Check to make sure session is not expired and set up a timer to call this function every minute.
                  checkSessionDuration();
                  awsData.timerId = setInterval(function(){checkSessionDuration();},60000);
              },
              error: function(err){
                  console.log('Error on making API gateway call to retrieve Dashboard list..');
                  console.log(err.responseText);
                  $('#DisplayMessage').html(err.responseText.replaceAll('"',''));
                }
              });      
  
        //Retrieve a dynamic dashboard embed url from QuickSight.
        //This is generated for a non existent dashboard id as this call is made in parallel to retrieving the dashboard list.
        $.ajax({
              url: awsData.apiGatewayUrl + '?mode=getUrl&urlType=dashboard&' + myQueryString,
              contentType: "text/plain",
              dataType: 'json',
              success: function(result){
                  console.log(result);
                  //------------
                  //Embedding the url to non-existent dashboard will result in an error screen in the div.
                  //However, on initial load, this div is hidden underneath status message screens.
                  //When user picks a dashboard from drop down, NavigateToDashboard function will load it (without generating another url)
                  //and then this div will be brought up to display layer.
                  //This is done to ensure that dashboard loads as quickly as possible once user makes a selection.
                  //-------------
                  //Alternatively, you can choose to generate the url and hold off on embedding till user selects a dashboard.
                  //In that case, you have to replace the string 'non-existent-id' in embed url with actual dashboard id.
                  //Also, an embed url has to be redeemed within 5 mins. 
                  //So, if following delayed load approach, you got generate fresh urls based on a timer till one gets embedded.
                  //OR you can choose to generate the url when user selects the initial dashboard.
                  //-------------
                  awsData.InitialDashboardEmbedUrl = result.DashboardEmbedUrl;
                  embedQuickSight('Dashboard', 'DashboardContainer',result.DashboardEmbedUrl);
                  
              },
              error: function(err){
                  console.log('Error on making API gateway call to retrieve dashboard embed url.');
                  console.log(err.responseText);
                  $('#DisplayMessage').html(err.responseText.replaceAll('"',''));
                }
              });

        //Retrieve a dynamic console embed url from QuickSight.
        $.ajax({
              url: awsData.apiGatewayUrl + '?mode=getUrl&urlType=console&' + myQueryString,
              contentType: "text/plain",
              dataType: 'json',
              success: function(result){
                  console.log(result);
                  embedQuickSight('Console', 'ConsoleContainer',result.ConsoleEmbedUrl);
              },
              error: function(err){
                  console.log('Error on making API gateway call to retrieve console embed url.');
                  console.log(err.responseText);
                  $('#DisplayMessage').html(err.responseText.replaceAll('"',''));
                }
              });
        
        //Retrieve Q embed url if configured.
        if( $('#DisplayParent').hasClass('ShowQ') ) 
        {
          $.ajax({
              url: awsData.apiGatewayUrl + '?mode=getUrl&urlType=q&qMode=' + awsData.qMode + '&' + myQueryString,
              contentType: "text/plain",
              dataType: 'json',
              success: function(result){
                  console.log(result);
                  embedQuickSight('Q', 'QContainer',result.QEmbedUrl);
              },
              error: function(err){
                  console.log('Error on making API gateway call to retrieve Q embed url.');
                  console.log(err.responseText);
                  $('#DisplayMessage').html(err.responseText.replaceAll('"',''));
                }
              });          
        }      
              
      }
  
      //Embed the generated url into the div identified to hold the dashboard/console/Q.
      async function embedQuickSight(entity, embedDiv, embedUrl) {
        console.log('In embedQuickSight func');
        
        //Set common frame and content options.
        const frameOptions = {
          url: embedUrl,
          container: "#"+embedDiv,
          width:"100%",
          height:"100%",
          withIframePlaceholder: true
        };
        
        if (entity == 'Dashboard'){
          
          frameOptions.onChange =  function(event){ HandleEvent('DASHBOARD-CHANGE-EVENT', event) };
          const contentOptions = {
            locale: "en-US",
            toolbarOptions: { export: false, undoRedo: false, reset: false },
            onMessage: function(event){ HandleEvent('DASHBOARD-MESSAGE-EVENT', event) }
          }
          
          awsData.embeddedDashboardExperience = await awsData.embeddingContext.embedDashboard(frameOptions,contentOptions);
          
        }
        else if (entity == 'Console'){
          
          frameOptions.onChange =  function(event){ HandleEvent('CONSOLE-CHANGE-EVENT', event) };
          const contentOptions = {
            locale: "en-US",
            onMessage: function(event){ HandleEvent('CONSOLE-MESSAGE-EVENT', event) }
          }
          
          awsData.embeddedConsoleExperience = await awsData.embeddingContext.embedConsole(frameOptions,contentOptions);
        }
        else {
          frameOptions.onChange =  function(event){ HandleEvent('Q-CHANGE-EVENT', event) };
          const contentOptions = {
            onMessage: function(event){ HandleEvent('Q-MESSAGE-EVENT', event) }
          }
          if ( awsData.qMode == 'Legacy' ){
            awsData.embeddedQExperience = await awsData.embeddingContext.embedQSearchBar(frameOptions, contentOptions);
          }
          else {
            contentOptions.panelOptions = {panelType: 'SEARCH_BAR'};
            awsData.embeddedQExperience = await awsData.embeddingContext.embedGenerativeQnA(frameOptions, contentOptions);
          }
        }
      }
      
      //Load the drop down list with dashboards that the user can access.
      //Show message to select a dashboard once the list is loaded.
      //Try sharing more dashboards with the user or EmbeddedReaderGrp and see them show up in the drop down on page refresh.
      function loadDashboardList(Dashboards)
      {
        console.log('In loadDashboardList func');
        //Load dashboard list if dashboard frame is loaded or else check back in a bit. Variable being checked is set from HandleEvents function. 
        if (awsData.dashboardClass == 'InitializedDashboard') {
          //Clear & load drop down list
          $('#SelectDashboard').empty();
          $('#SelectDashboard').append($('<option></option>').val('non-existent-id').html(' '));
          $.each(Dashboards, function(index, dashboard) {
            $('#SelectDashboard').append($('<option></option>').val(dashboard.DashboardId).html(dashboard.Name));
          });
          if (Dashboards.length > 0)
          {
             $('#DisplayMessage').html('Please select a dashboard to view.');
          }
          else
          {
            $('#DisplayMessage').html('Share a dashboard with this user or relevant EmbeddedDemoReaders group in QuickSight. <br> Then, try refreshing this page.');
          }
        }
        else {
          setTimeout(function(){loadDashboardList(Dashboards);}, 500);
        }
        
  
      }
      
      //Bring the dashboard div to top layer when invoked with show action and vice versa for hide.
      //Also, remove the empty placeholder from the dashboard selection drop down on initial invocation.
      function setVisibility(mode){
        console.log('In setVisibility func : mode is '+mode);
        
        if ( mode == 'Dashboard' ) {
          $('#TopContainer').removeClass().addClass(awsData.dashboardClass);
          $('#NavEmbeddedDashboards').removeClass('text-secondary').addClass('text-primary');
          $('#NavEmbeddedConsole').removeClass('text-primary').addClass('text-secondary');
        }
        else {
          $('#TopContainer').removeClass().addClass('Console');
          $('#NavEmbeddedDashboards').removeClass('text-primary').addClass('text-secondary');
          $('#NavEmbeddedConsole').removeClass('text-secondary').addClass('text-primary');
        }
        
      }
      
      //Load selected dashboard using the navigateToDashboard function.
      //On initial invocation, add a 1 sec delay to the dashboard div being brought to top layer to avoid showing error screen.
      //(ie the error stating that dashboard non-existent-id doesn't exist. See comments further above for more details.)
      function selectDashboard(dashboardId){
        console.log('In selectDashboard func');
        if (dashboardId != 'non-existent-id')
        {
          if (awsData.dashboardInitialLoad) {
            $('#SelectDashboard option[value="non-existent-id"]').remove();
            awsData.dashboardInitialLoad = false;
          }
          
          const options={}
          awsData.embeddedDashboardExperience.navigateToDashboard(dashboardId, options);
          
        }
      }
  
      function checkSessionDuration(){
        console.log('In checkSessionDuration function');
        expiryTs = getCookieField('expiryTs')
        if (expiryTs)
        {
          sessionDuration = parseInt((expiryTs - (Date.now()/1000) )/60 );
          sessionDuration = sessionDuration >= 0 ? sessionDuration : 0 ;
          
          if (sessionDuration == 0)
          {
            signOut();
          }
        }
        else
        {
          signOut();
        }
        
      }
      
      //Signout of the current Cognito session.
      function signOut(){
        console.log('In signOut Function');
        setCookie('QSEmbedDemo', '');
        clearInterval(awsData.timerId);
        window.location.href = awsData.cognitoDomainUrl+'/logout?client_id='+awsData.cognitoClientId+'&logout_uri='+awsData.staticPageUrl;
      }
      
      function HandleEvent(source, event){
        console.log('--'+source+'-----------------');
        console.log(event);
    
        console.log('\n');
        
        //Waiting for embedded dashboard to initialize before loading dashboardlist. 
        //LoadDashboardList function waits for InitializedDashboard class to be available before loading the list.
        if ( source == 'DASHBOARD-MESSAGE-EVENT' && event.eventName == 'EXPERIENCE_INITIALIZED') {
          awsData.dashboardClass = 'InitializedDashboard';
          $('#TopContainer').removeClass('UninitializedDashboard').addClass(awsData.dashboardClass);
        }
        
        if ( source == 'DASHBOARD-MESSAGE-EVENT' && event.eventName == 'NAVIGATE_TO_DASHBOARD') {
          awsData.dashboardClass = 'Dashboard';
          $('#TopContainer').removeClass('InitializedDashboard').addClass(awsData.dashboardClass);
        }
      }
        
    </script>
  </head>
  <body>
    <div id="TopContainer" class="UninitializedDashboard">
      <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top" >
        <a class="navbar-brand" >
          <img id="NavbarLogo" src="data:image/png;base64,<LogoFileBase64>" alt="" loading="lazy">
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul id = "NavViewSelection" class="navbar-nav ml-auto">
            <li class="nav-item active">
              <a id="NavEmbeddedConsole" class="nav-link text-secondary " href="#" >Embedded Console View</a>
            </li>
            <li class="nav-item active">
              <a id="NavEmbeddedDashboards" class="nav-link text-primary " href="#" >Embedded Dashboard View</a>
            </li>
          </ul>
          
          <ul id="NavDashboards" class="navbar-nav" >
            <li id="DashboardSelectorHeader" class="nav-item inactive">
              <a class="nav-link text-secondary "> Select Dashboard </a>
            </li>
            <li id="DashboardSelector" class="nav-item active">
              <select class="form-control text-secondary" id="SelectDashboard" )>
              </select>
            </li>
            <li class="nav-item active">
                <a id ="NavSignOut" class="nav-link text-secondary" href="#" >LogOut</a>
            </li>
          </ul>
        </div>
      </nav>
      
      <div id="DisplayParent" >
        <div id="DashboardContainer">
        </div>
        <div id="DisplayMessageContainer" class="overflow-auto" >
          <div class="jumbotron jumbotron-fluid col text-center" >
            <div class="container" >
              <h4 id="DisplayMessage" class="text-secondary">Loading..</h4>
            </div>
          </div>
        </div>
        <div id="ConsoleContainer">
        </div>
        <div id="QBackdrop" style="visibility:hidden"></div>
        <div id="QContainer"></div>
      </div>
    </div>  
  </body>
</html>
